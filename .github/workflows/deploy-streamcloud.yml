name: StreamCloud Sweden CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  
  ACR_NAME: streamcloudreg26940
  CLUSTER_NAME: streamcloudaks
  RESOURCE_GROUP: StreamCloudRG_Sweden

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # 1. Autentificare in Azure
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 2. Autentificare in ACR
    - name: ACR Login
      run: az acr login --name $ACR_NAME

    # 3. Build si push
    - name: Build and Push Docker Image
      run: |
        docker build . -t $ACR_NAME.azurecr.io/streamcloud-player:${{ github.run_number }}
        docker push $ACR_NAME.azurecr.io/streamcloud-player:${{ github.run_number }}

    # 4. Conectare la Kubernetes 
    - name: Set AKS Context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.RESOURCE_GROUP }}
        cluster-name: ${{ env.CLUSTER_NAME }}

    # 5. Actualizare Site
    - name: Deploy to Kubernetes
      run: |
        sed -i "s|image: .*|image: $ACR_NAME.azurecr.io/streamcloud-player:${{ github.run_number }}|g" k8s-deployment.yaml
        kubectl apply -f k8s-deployment.yaml
